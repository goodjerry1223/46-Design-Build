# STM32F446 电机控制项目引脚功能说明

## 引脚分配总览

| 引脚 | 功能 | 配置模式 | 说明 |
|------|------|----------|------|
| PA0 | TIM2_CH1 | 编码器模式 | 电机A编码器A相信号 |
| PA1 | TIM2_CH2 | 编码器模式 | 电机A编码器B相信号 |
| PA2 | ADC1_IN2 | ADC采集模式 | 电机驱动板输入电压检测 |
| PA6 | TIM3_CH1 | PWM输出模式 | 电机A控制引脚1 |
| PA7 | TIM3_CH2 | PWM输出模式 | 电机A控制引脚2 |
| PB0 | TIM3_CH3 | PWM输出模式 | 电机B控制引脚1 |
| PB1 | TIM3_CH4 | PWM输出模式 | 电机B控制引脚2 |
| PB6 | TIM4_CH1 | 编码器模式 | 电机B编码器A相信号 |
| PB7 | TIM4_CH2 | 编码器模式 | 电机B编码器B相信号 |

## 详细功能说明

### 1. 编码器功能 (TIM2和TIM4)

#### 电机A编码器 (PA0, PA1)
- **定时器**: TIM2
- **引脚**: PA0 (TIM2_CH1), PA1 (TIM2_CH2)
- **模式**: 编码器模式 (TIM_ENCODERMODE_TI12)
- **功能**: 读取电机A编码器数据，计算电机A转速

#### 电机B编码器 (PB6, PB7)
- **定时器**: TIM4
- **引脚**: PB6 (TIM4_CH1), PB7 (TIM4_CH2)
- **模式**: 编码器模式 (TIM_ENCODERMODE_TI12)
- **功能**: 读取电机B编码器数据，计算电机B转速

#### 编码器使用示例
```c
// 启动编码器
HAL_TIM_Encoder_Start(&htim2, TIM_CHANNEL_ALL);  // 电机A
HAL_TIM_Encoder_Start(&htim4, TIM_CHANNEL_ALL);  // 电机B

// 读取编码器值
int32_t encoderA_value = __HAL_TIM_GET_COUNTER(&htim2);
int32_t encoderB_value = __HAL_TIM_GET_COUNTER(&htim4);

// 计算转速 (需要定时采样)
static int32_t last_encoderA = 0;
static int32_t last_encoderB = 0;
int32_t deltaA = encoderA_value - last_encoderA;
int32_t deltaB = encoderB_value - last_encoderB;
// 转速 = delta / 采样时间
```

### 2. PWM电机控制 (TIM3)

#### 电机A控制 (PA6, PA7)
- **定时器**: TIM3
- **引脚**: PA6 (TIM3_CH1), PA7 (TIM3_CH2)
- **模式**: PWM输出模式
- **PWM频率**: 84MHz / 72 / 1000 = 1.17kHz
- **分辨率**: 1000级 (0-999)

#### 电机B控制 (PB0, PB1)
- **定时器**: TIM3
- **引脚**: PB0 (TIM3_CH3), PB1 (TIM3_CH4)
- **模式**: PWM输出模式
- **PWM频率**: 84MHz / 72 / 1000 = 1.17kHz
- **分辨率**: 1000级 (0-999)

#### 电机控制示例

##### 方式1：使用底层PWM控制
```c
// 启动PWM输出
HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_1);  // PA6
HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_2);  // PA7
HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_3);  // PB0
HAL_TIM_PWM_Start(&htim3, TIM_CHANNEL_4);  // PB1

// 电机A正转 (PA6输出PWM，PA7输出低电平)
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_1, 500);  // 50%占空比
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_2, 0);    // 0%占空比

// 电机A反转 (PA6输出低电平，PA7输出PWM)
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_1, 0);    // 0%占空比
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_2, 500);  // 50%占空比

// 电机A停止 (两个引脚都输出低电平)
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_1, 0);
__HAL_TIM_SET_COMPARE(&htim3, TIM_CHANNEL_2, 0);
```

##### 方式2：使用电机控制函数库
```c
#include "motor_control.h"

// 设置具体速度 (-1000到1000)
set_motor_speed(1, 800);   // 电机A正转，速度80%
set_motor_speed(2, -600);  // 电机B反转，速度60%

// 使用简化函数 (默认50%速度)
motor_forward(1);   // 电机A正转
motor_backward(2);  // 电机B反转
motor_stop(1);      // 电机A停止

// 使用专用函数
set_motorA_speed(700);  // 电机A 70%速度正转
set_motorB_speed(-400); // 电机B 40%速度反转
motorA_forward();       // 电机A正转
motorB_backward();      // 电机B反转
```

### 3. 电压检测 (ADC1)

#### 输入电压检测 (PA2)
- **ADC**: ADC1
- **引脚**: PA2 (ADC1_IN2)
- **模式**: ADC采集模式
- **分辨率**: 12位 (0-4095)
- **参考电压**: 3.3V
- **分压比**: 11:1 (输入电压 = ADC值 × (3.3V × 11 / 4096))

#### 电压检测示例
```c
// 启动ADC
HAL_ADC_Start(&hadc1);

// 读取ADC值
uint32_t adc_value = 0;
HAL_ADC_PollForConversion(&hadc1, 100);  // 等待转换完成
adc_value = HAL_ADC_GetValue(&hadc1);     // 读取ADC值

// 计算输入电压
float input_voltage = adc_value * (3.3f * 11.0f / 4096.0f);
// 例如：ADC值 = 2000，则输入电压 = 2000 × (3.3 × 11 / 4096) = 17.7V
```

## 系统时钟配置

- **系统时钟**: 84MHz
- **APB1时钟**: 42MHz (定时器2,3,4时钟)
- **APB2时钟**: 84MHz (ADC时钟)

## 注意事项

1. **编码器模式**: TIM2和TIM4已配置为编码器模式，可以自动处理A、B相信号的相位关系
2. **PWM控制**: 通过设置不同通道的PWM占空比来控制电机的方向和转速
3. **电压检测**: ADC采样需要等待转换完成，建议使用中断或DMA方式
4. **引脚复用**: 确保在STM32CubeMX中正确配置了引脚复用功能

## 电机控制函数库

### 函数列表

#### 通用控制函数
- `set_motor_speed(motor, speed)`: 设置指定电机的速度
  - `motor`: 电机编号 (1=电机A, 2=电机B)
  - `speed`: 速度值 (-1000到1000，负值表示反转)

- `motor_forward(motor)`: 电机正转 (50%速度)
- `motor_backward(motor)`: 电机反转 (50%速度)
- `motor_stop(motor)`: 电机停止

#### 专用控制函数
- `set_motorA_speed(speed)`: 设置电机A速度
- `set_motorB_speed(speed)`: 设置电机B速度
- `motorA_forward()`: 电机A正转
- `motorA_backward()`: 电机A反转
- `motorA_stop()`: 电机A停止
- `motorB_forward()`: 电机B正转
- `motorB_backward()`: 电机B反转
- `motorB_stop()`: 电机B停止

#### 组合控制函数
- `motorStraight(speed)`: 直线前进/后退
  - `speed`: 速度值 (-1000到1000，正值前进，负值后退)
- `motorReverse(speed)`: 倒车
  - `speed`: 速度值 (0到1000，正值表示倒车速度)
- `motorTurnLeft(time)`: 左转
  - `time`: 转向时间 (毫秒)
- `motorTurnRight(time)`: 右转
  - `time`: 转向时间 (毫秒)

### 使用示例

```c
// 包含头文件
#include "motor_control.h"

// 基本控制
motor_forward(1);      // 电机A正转
motor_backward(2);     // 电机B反转
motor_stop(1);         // 电机A停止

// 精确速度控制
set_motor_speed(1, 800);   // 电机A 80%速度正转
set_motor_speed(2, -600);  // 电机B 60%速度反转

// 专用函数
motorA_forward();          // 电机A正转
set_motorB_speed(-400);    // 电机B 40%速度反转

// 组合控制
motorStraight(800);        // 两个电机同时以80%速度前进
motorStraight(-600);       // 两个电机同时以60%速度后退
motorReverse(500);         // 倒车，速度50%
motorTurnLeft(1000);       // 左转1秒
motorTurnRight(500);       // 右转0.5秒
```

### 直线运动控制

`motorStraight(speed)` 函数专门用于控制小车直线运动：

- **正值**: 前进运动
  - `motorStraight(500)` - 50%速度前进
  - `motorStraight(1000)` - 全速前进
- **负值**: 后退运动
  - `motorStraight(-300)` - 30%速度后退
  - `motorStraight(-800)` - 80%速度后退
- **零值**: 停止运动
  - `motorStraight(0)` - 停止

这个函数会自动同步两个电机的速度，确保小车直线运动。

### 转向控制

`motorTurnLeft(time)` 和 `motorTurnRight(time)` 函数用于控制小车转向：

#### 左转控制
- `motorTurnLeft(500)` - 左转0.5秒
- `motorTurnLeft(1000)` - 左转1秒
- `motorTurnLeft(2000)` - 左转2秒

#### 右转控制
- `motorTurnRight(500)` - 右转0.5秒
- `motorTurnRight(1000)` - 右转1秒
- `motorTurnRight(2000)` - 右转2秒

#### 转向原理
- **左转**: 电机A前进，电机B后退
- **右转**: 电机A后退，电机B前进
- **转向速度**: 固定50%速度
- **自动停止**: 转向完成后自动停止两个电机

#### 转向角度估算
转向角度与时间的关系取决于小车的物理参数：
- 轮距 (两个轮子之间的距离)
- 轮子直径
- 转向速度

一般经验值：
- 0.5秒 ≈ 45度
- 1秒 ≈ 90度
- 2秒 ≈ 180度

### 倒车控制

`motorReverse(speed)` 函数用于倒车：
- `motorReverse(500)` - 50%速度倒车
- `motorReverse(800)` - 80%速度倒车
- `motorReverse(1000)` - 全速倒车

## 常见应用场景

1. **双轮差速小车**: 通过控制两个电机的转速实现转向
2. **位置控制**: 通过编码器反馈实现精确位置控制
3. **速度控制**: 通过编码器反馈实现闭环速度控制
4. **电压监控**: 实时监控电机驱动板输入电压，防止过压或欠压 